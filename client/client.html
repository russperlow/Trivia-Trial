<!DOCTYPE html>
<html lang='en'>
    <head>
        <title>Trivia Trial</title>
        <link rel='stylesheet' type='text/css' href='/style.css'>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
        <script type='text/babel'>
        const parseJSON = (xhr, content) => {
            const obj = JSON.parse(xhr.response);
            console.log(obj);

            if(obj.question && obj.answer){
                const trivaQuestion = document.getElementById('triviaQuestion');
                triviaQuestion.textContent = JSON.stringify(obj.question);
                const triviaAnswer = document.getElementById('triviaAnswer');
                triviaAnswer.textContent = obj.answer;
                triviaAnswer.style.display = 'none';
                startTimer();
            }
        };

        const handleResponse = (xhr, parseResponse) => {
            const content = document.querySelector('#content');
            console.log(xhr);
            switch(xhr.status){
                case 200:
                    break;
                case 201:
                    document.getElementById('content').textContent = `Trivia Question Submission Success`;
                    break;
                case 204:
                    break;
                case 400:
                    document.getElementById('content').textContent = `Error ${xhr.status} ${xhr.statusText}`;
                    break;
                case 404:
                    document.getElementById('content').textContent = `Error ${xhr.status} ${xhr.statusText}`;
                    break;
                default:
                    break;
            }

            setTimeout(() => {
                hideContent();
            }, 2500);


            if(parseResponse){
                parseJSON(xhr, content);
            }
        };

        const hideContent = () => {
            document.getElementById('content').textContent = '';
        }

        const post = (e, triviaForm) => {
            const triviaAction = triviaForm.getAttribute('action');
            const triviaMethod = triviaForm.getAttribute('method');

            const questionField = triviaForm.querySelector('#questionField');
            const answerField = triviaForm.querySelector('#answerField');

            const xhr = new XMLHttpRequest();
            xhr.open(triviaMethod, triviaAction);

            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            xhr.setRequestHeader('Accept', 'application/json');
            xhr.onload = () => handleResponse(xhr, true);

            const formData = `question=${questionField.value}&answer=${answerField.value}`;
            xhr.send(formData);

            e.preventDefault();
            return false;  
        };
        
        const requestUpdate = (e, triviaForm) => {
            const action = triviaForm.getAttribute('action');
            const method = triviaForm.getAttribute('method');
           
            const xhr = new XMLHttpRequest();

            xhr.open(method, action);
            xhr.onload = () => handleResponse(xhr, true);
            xhr.send();

            e.preventDefault();
            return false;
        };

        let timerFunc, time = 10, userScore = 0;

        const startTimer = () => {
            let timer = document.getElementById('timer');
            timer.textContent = 10;

            timerFunc = setInterval(() => {
                if(time <= 0){
                    stopTimer();
                }

                timer.textContent = `Time Remaining: ${time--}`;
            }, 1000);
        };

        const stopTimer = () => {
            clearInterval(timerFunc);
        }

        const checkUserAnswer = (e) => {
            let userAnswer = document.getElementById('userGuessText').value;
            let answer = document.getElementById('triviaAnswer').textContent;

            console.log(userAnswer);
            console.log(answer);

            if(userAnswer == answer){
                document.getElementById('userScore').textContent = `Score: ${++userScore}`;
                document.getElementById('userGuessResult').textContent = 'Correct!';
            }else{
                document.getElementById('userGuessResult').textContent = 'Incorrect! The right answer was: ';
                let answerP = document.getElementById('triviaAnswer');
                answerP.style.display = 'block';
            }

            e.preventDefault();
            return false;
        }

        const init = () => {
            const addTriviaForm = document.querySelector('#addQuestionForm');
            const getTriviaForm = document.querySelector('#getQuestionForm');

            const addTrivia = (e) => post(e, addTriviaForm);
            const getTrivia = (e) => requestUpdate(e, getTriviaForm);

            addTriviaForm.addEventListener('submit', addTrivia)
            getTriviaForm.addEventListener('submit', getTrivia);

            document.getElementById('addQuestions').addEventListener('click', function(){
                document.getElementById('initText').style.display = 'none';
                document.getElementById('addQuestions').style.display = 'none';
                document.getElementById('addQuestionsDiv').style.display = 'block'; 
            });

            document.getElementById('beginPlaying').addEventListener('click', function(){
                document.getElementById('initText').style.display = 'none';
                document.getElementById('addQuestions').style.display = 'none';
                document.getElementById('beginPlaying').style.display = 'none';
                document.getElementById('playDiv').style.display = 'block'; 
            });

            const userAnswer = (e) => checkUserAnswer(e)
            document.getElementById('userGuessForm').addEventListener('submit', userAnswer);
        };

        window.onload = init;
        </script>
    </head>
    <body>
        <h1>Welcome to Trivia Trial!</h1>

        <h3 id='initText'>Would you like to add questions or begin playing?</h3>
        
        <div id='playDiv'>
            <h3>When you are ready, hit the New Question button. You will have 10 seconds from each new question to guess the answer!</h3>
            <h3>If you are right, you score a point!</h3>
            <h4 id='userScore'></h4>

            <h4 id='timer'></h4>

            <p id='triviaQuestion'></p>
            <p id='userGuessResult'></p>
            <p id='triviaAnswer'></p>

            <form id='getQuestionForm' action='getTrivia' method='get'>
                <input type='submit' value='New Question'/>
            </form>

            <form id='userGuessForm'>
                <input type='text' id='userGuessText' />
                <input type='submit' value='Submit Guess'/>
            </form>

            <!-- <button id='showAnswer' onclick='document.getElementById("triviaAnswer").style.display ="block";'>Show Answer</button> -->
        </div>

        <div id='addQuestionsDiv'>
            <h3>Add as many questions as you would like! </h3>
            <form id='addQuestionForm' action='/addTrivia' method='post'>
                <label for='question'>Question:</label>
                <input id='questionField' type='text' name='question' />
                <label for='answer'>Answer:</label>
                <input id='answerField' type='text' name='answer' />
                <input type='submit' value='Submit Question'/>
            </form>
        </div>

        <button id='addQuestions'>Add Questions</button>
        <button id='beginPlaying'>Begin Playing</button>

        <p id='content'></p>
    </body>
</html>